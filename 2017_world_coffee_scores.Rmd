---
title: "Observing Max Average Coffee Scores (2017)"
output:
  html_document:
    df_print: paged
---

This notebook is a part of Google Data Analytics Professional Certificate case study. The notebook showcases of how to use R to manipulate data and answer a business question.

**Question:** What are the top 3 countries that produce the highest average cupping scores?

Firstly, import R packages "tidyverse", "ggplot2", "dplyr", and "janitor".  

```{r}
library("tidyverse")
library("ggplot2")
library("dplyr")
library("janitor")
```

The next step is to load in the dataframe and explore it.
```{r}
arabica_quality <- read_csv("arabica_quality_data.csv")
summary(arabica_quality)
```

Next one is to calculate the percentages of each column missing values.

```{r}
missing_percentage <- arabica_quality %>% 
  summarize_all(funs(round((sum(is.na(.)) / length(.)) * 100)), digits = 2)

#Use pivot_longer to better show the result in longer format
missing_percentage <- pivot_longer(missing_percentage, cols = colnames(missing_percentage), names_to = "col_name", values_to = "percentage")

#Sort the values in descending order
missing_percentage[order(missing_percentage$percentage, decreasing = TRUE), ]
```

The column **Lot.Number** can be entirely dropped due to the very high percentage of missing values. 

The dataframe is also needed to be sliced in order to get only the following columns. These column names are also needed to be cleaned. 

1. Owner
2. Country.of.Origin 
3. Farm.Name 
4. Altitude
5. Region 
6. Producer 
7. Variety 
8. Processing.Method 
9. Aroma 
10. Flavor
11. Aftertaste 
12. Acidity 
13. Body 
14. Balance 
15. Uniformity 
16. Clean.Cup 
17. Sweetness 
18. Cupper.Points 
19. Total.Cup.Points 



```{r}
#Clean column names with backing up the data
arabica_col_cleaned <- clean_names(arabica_quality)
head(arabica_col_cleaned)

```

```{r}
#Slice columns to only get the columns above
arabica_final_cols <- arabica_col_cleaned[, c("owner", "country_of_origin", "farm_name", "altitude", "region", "producer", "variety", "processing_method", "aroma", "flavor", "aftertaste", "acidity", "body", "balance", "uniformity", "clean_cup", "sweetness", "cupper_points", "total_cup_points")]

head(arabica_final_cols)
```

Check for the number of missing values again in each columns.

```{r}
colSums(is.na(arabica_final_cols))  
```

It seems that there are so many missing values here for string columns, however the numeric columns such as **total_cup_points** and the others have no missing values.

Next up, observe the **owner** column first to decide what to do with the NAs.

```{r}
owner_na <- arabica_final_cols[is.na(arabica_final_cols$owner),]

owner_na
```
All of the missing owner values are in **Honduras** and **Colombia**.

Therefore, dig more into **Honduras** country to see if those NAs can be filled with some information by extracting the Honduras out from **arabica_final_cols**. Then filter only the NAs in the Honduras.

```{r}
honduras <- arabica_final_cols %>% 
  filter(country_of_origin == "Honduras")
honduras[is.na(honduras$owner),]
```

We can see that the missing owner values are from either "**los hicaques**" or "**gran manzana y el aguacate**" farm so we will filter out only all row in those 2 farms in Honduras. 

```{r}
hon_farm <- c("los hicaques", "gran manzana y el aguacate")
filter(honduras, farm_name %in% hon_farm)
```

It seems that those missing values from owner can be all filled in with the information from the same farm_name. 

```{r}
#Fill in NAs of los hicaques with bismarck castro
arabica_final_cols$owner[is.na(arabica_final_cols$owner) & arabica_final_cols$farm_name == "los hicaques"] <- "bismarck castro"

#Fill in NAs of gran manzana y el aguacate farm with Tomás Sosa, Juan Damaso
arabica_final_cols$owner[is.na(arabica_final_cols$owner) & arabica_final_cols$farm_name == "gran manzana y el aguacate"] <- "Tomás Sosa, Juan Damaso"

#Check if the owner of Honduras still contains NA?
subset(arabica_final_cols, country_of_origin == "Honduras" & is.na(owner) == TRUE)
```

Check for **Colombia** country where the farm_name is "**supply chain ecom cca s.a.**"

```{r}
subset(arabica_final_cols, farm_name == "supply chain ecom cca s.a.")
```

There is only 1 row so I will fill in the NA of the owner column with the producer name. 

```{r}
arabica_final_cols$owner[is.na(arabica_final_cols$owner) & arabica_final_cols$farm_name == "supply chain ecom cca s.a."] <- "Supply Chain ECOM CCA S.A."

#Check total NA in the owner column
sum(is.na(arabica_final_cols$owner))
```
Move to the **country_of_origin** column that contains 1 missing value. 

```{r}
arabica_final_cols[is.na(arabica_final_cols$country_of_origin),]
```

We can only use "**racafe & cia s.c.a**" from the owner column to try to fill in its **country_of_origin** column. 

After searching the owner name, we found that it is from **Colombia** so we can use it to fill in the country.

```{r}
#Fill in the only NA in country_of_origin column with Colombia
arabica_final_cols$country_of_origin[is.na(arabica_final_cols$country_of_origin)] <- "Colombia"

#Confirm that country_of_origin contains no missing value
sum(is.na(arabica_final_cols$country_of_origin))
```
We have already cleaned two columns but there are still more missing values in the other columns. However, they will not affect our analysis except that the stakeholders still need to know more information about those beans (only if the end result show the rows that contained with missing values). 

Next up, we will check if the **total_cup_points** are summed up correctly or not.

```{r}
#Sum up the numbers from aroma column to cupper_points column and compare it with the total_cup_points column.
check_total_points <- arabica_final_cols %>% 
  mutate(correct_total_points = select(., aroma:cupper_points) %>% 
           rowSums(na.rm = TRUE))

head(check_total_points[, c("total_cup_points", "correct_total_points")], n = 10)
```

The **total_points** are accurate with some differs less than 0.01 points so this column can be used.

Next, we will drop from **aroma** column to **cupper_points** column as we will not need them for the analysis process.

```{r}
arabica_final_cols_sliced <- arabica_final_cols[, c("owner", "country_of_origin", "farm_name", "altitude", "region", "producer", "variety", "processing_method", "total_cup_points")]

head(arabica_final_cols_sliced)
```

Check if there is any incorrect or outlier points in the **total_cup_points** column against the **country_of_origin** column.

```{r}
#Use boxplot to identify the outliers 
ggplot(arabica_final_cols_sliced, aes(x = country_of_origin, y = total_cup_points)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90))
```

It seems that there is one incorrect point in the  **total_cup_points** column so, we will observe it.

```{r}
unique(arabica_final_cols_sliced$total_cup_points)
```

Notice that there is **0.00** score in the last row, but I need to check if the other score columns can be used to help in calculation or not.

```{r}
arabica_quality[arabica_quality$Total.Cup.Points == 0.00, ]
```

Those all scores columns are also 0 and we could not find other information on the Internet so we will drop this row out.

```{r}
#Get the row index first
which(arabica_final_cols_sliced$total_cup_points == 0.00,) #This will result at 1311 index

#Remove that row
arabica_final_cols_sliced <- arabica_final_cols_sliced[-c(1311), ]

#Confirm again if it has already been removed by checking the min value of the column
min(arabica_final_cols_sliced$total_cup_points)
```

Now, we are ready to answer the question by aggregating the data.

```{r}
arabica_quality_analysed <- arabica_final_cols_sliced %>% 
  group_by(country_of_origin) %>%
  summarise(across(total_cup_points, mean, na.rm = TRUE))

final_answer <- arabica_quality_analysed %>% 
  arrange(desc(total_cup_points))

colnames(final_answer) <- c("country", "average_cupping_scores")

head(final_answer, n = 3)
```
It surprises us that the highest average cupping score is from the US instead of Colombia or Ethiopia which are well-known countries for producing high quality coffee, so it is worth to observe more about coffee in the US. 

```{r}
arabica_final_cols_sliced[arabica_final_cols_sliced$country_of_origin == "United States", ]
```
The result shows that the original beans are not from the US because the farm name and most of the regions are in Colombia and the last two are in Indonesia and Guatemala respectively. On the other hand, this also tells us that the US is one of the top roasters in the World!

We will need to replace all the **United States** in the **country_of_origin** with the countries listed above.

```{r}
arabica_final_cols_sliced$country_of_origin[ arabica_final_cols_sliced$country_of_origin == "United States"] <- c("Colombia", "Colombia", "Colombia", "Colombia", "Colombia", "Colombia", "Indonesia", "Guatemala")

#Check if whether is there any other United States left or not?
table(arabica_final_cols_sliced$country_of_origin)
```
After observing the **country_of_origin** again, we also need to clean some of the following country names to make them more clear:

1. Tanzania, United Republic Of <- Tanzania
2. United States (Hawaii) <- Hawaii
3. United States (Puerto Rico) <- Puerto Rico

```{r}
#Change the country names above
arabica_final_cols_sliced$country_of_origin[arabica_final_cols_sliced$country_of_origin == "Tanzania, United Republic Of"] <- "Tanzania"

arabica_final_cols_sliced$country_of_origin[arabica_final_cols_sliced$country_of_origin == "United States (Hawaii)"] <- "Hawaii"

arabica_final_cols_sliced$country_of_origin[arabica_final_cols_sliced$country_of_origin == "United States (Puerto Rico)"] <- "Puerto Rico"
               
#Check again the country_of_origin column again
table(arabica_final_cols_sliced$country_of_origin)
```
We will group up the data with the **country_of_origin** again to see if the result will be changed or not. 

```{r}
arabica_quality_analysed_2 <- arabica_final_cols_sliced %>%
  group_by(country_of_origin) %>%
  summarise(across(total_cup_points, mean, na.rm = TRUE))

final_answer_2 <- arabica_quality_analysed_2 %>% 
  arrange(desc(total_cup_points))

colnames(final_answer_2) <- c("country", "average_cupping_scores")

head(final_answer_2, n = 3)
```
The result has changed! We still need to keep in mind that some countries sent in only 1 sample so we will add every country's max score in order to compare with their average scores and make it less bias.

```{r}
arabica_quality_analysed_3 <- arabica_final_cols_sliced %>%
  group_by(country_of_origin) %>%
  summarise(average_cupping_scores = mean(total_cup_points, na.rm = TRUE), max_cupping_scores = max(total_cup_points, na.rm = TRUE))

final_answer_3 <- arabica_quality_analysed_3 %>% 
  arrange(country_of_origin)

colnames(final_answer_3)[1] <- "country"

#Round the numberof average_cupping_scores
final_answer_3$average_cupping_scores <- round(final_answer_3$average_cupping_scores, 2)

head(final_answer_3, n = 5)
```

Last step is to export this dataframe into a CSV file in order to visualise it using Tableau.

```{r}
write.csv(final_answer_3, file = 'C:\\Users\\medse\\OneDrive\\Desktop\\Google Data Analytics Cert\\Sample_Data\\Case_study_data\\2017_world_coffee_socres_analysed.csv', row.names = FALSE)
```






